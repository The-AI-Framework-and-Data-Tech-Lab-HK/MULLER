
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://The-AI-Framework-and-Data-Tech-Lab-HK.github.io/MULLER/getting_started/5_advanced_operations/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>5 advanced operations - MULLER</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#advanced-operations" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="MULLER" class="md-header__button md-logo" aria-label="MULLER" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            MULLER
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              5 advanced operations
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Change to the bright mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Change to the bright mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Change to the dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Change to the dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Introduction

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../installation/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/dataset.md" class="md-tabs__link">
          
  
  
  API Documents

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../faq.md" class="md-tabs__link">
        
  
  
    
  
  FAQ

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="MULLER" class="md-nav__button md-logo" aria-label="MULLER" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    MULLER
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Install
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../1_read_muller_object/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Read as MULLER object
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../2_create_muller_dataset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Construct a MULLER dataset
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../3_muller_dataset_operations%28load%2Cappend%2Cupdate%2Cdelete%2Cquery%29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Load, Append, Update, Delete, Query in a MULLER dataset
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API Documents
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Documents
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/dataset.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dataset
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../faq.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FAQ
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#advanced-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Advanced Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-recommendations-for-ingesting-large-scale-data-into-muller-datasets" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Recommendations for Ingesting Large-Scale Data into MULLER Datasets
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-use-with-for-better-write-performance" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Use with for Better Write Performance
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-why-a-dataset-become-corrupted-and-how-to-recover" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Why a Dataset Become Corrupted, and How to Recover?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-keys-to-efficient-operations-on-obs" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Keys to Efficient Operations on OBS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-concurrency-write-locks-in-muller" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Concurrency: Write Locks in MULLER
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-how-is-muller-different-from-deeplake" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. How Is MULLER Different from Deeplake?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-other" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Other
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



  <h1>5 advanced operations</h1>

<h2 id="advanced-operations">Advanced Operations</h2>
<h3 id="1-recommendations-for-ingesting-large-scale-data-into-muller-datasets">1. Recommendations for Ingesting Large-Scale Data into MULLER Datasets</h3>
<p>If you need to create a dataset or append a large amount of data in the MULLER format, it is recommended to use the <code>@muller.compute</code> decorator for parallel ingestion (typically set <code>num_workers</code> to 8–32 depending on available resources).</p>
<blockquote>
<p>Notes:</p>
<ul>
<li>Multiprocessing/multithreading has overhead; the speedup becomes noticeable mainly for hundreds of thousands to millions of samples.</li>
</ul>
</blockquote>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_cifar10_dataset_parallel</span><span class="p">(</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="s2">&quot;threaded&quot;</span><span class="p">):</span>
    <span class="n">ds_multi</span> <span class="o">=</span> <span class="n">muller</span><span class="o">.</span><span class="n">dataset</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s2">&quot;./temp_test&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">ds_multi</span><span class="p">:</span>
        <span class="n">ds_multi</span><span class="o">.</span><span class="n">create_tensor</span><span class="p">(</span><span class="s2">&quot;test1&quot;</span><span class="p">,</span> <span class="n">htype</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="n">ds_multi</span><span class="o">.</span><span class="n">create_tensor</span><span class="p">(</span><span class="s2">&quot;test2&quot;</span><span class="p">,</span> <span class="n">htype</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>

    <span class="c1"># Add data row-by-row to preserve row-level atomicity</span>
    <span class="n">iter_dict</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100000</span><span class="p">):</span>
        <span class="n">iter_dict</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;hi&quot;</span><span class="p">,</span> <span class="s2">&quot;hello&quot;</span><span class="p">)))</span>  <span class="c1"># Example only; load any data in practice</span>

    <span class="nd">@muller</span><span class="o">.</span><span class="n">compute</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">file_to_muller</span><span class="p">(</span><span class="n">data_pair</span><span class="p">,</span> <span class="n">sample_out</span><span class="p">):</span>
        <span class="n">sample_out</span><span class="o">.</span><span class="n">test1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">sample_out</span><span class="o">.</span><span class="n">test2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">sample_out</span>

    <span class="k">with</span> <span class="n">ds_multi</span><span class="p">:</span>
        <span class="n">file_to_muller</span><span class="p">()</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span>
            <span class="n">iter_dict</span><span class="p">,</span>
            <span class="n">ds_multi</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">,</span>
            <span class="n">disable_rechunk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">ds_multi</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="n">create_cifar10_dataset_parallel</span><span class="p">(</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="s2">&quot;processed&quot;</span><span class="p">)</span>
</code></pre></div>
<p>For large-scale ingestion, <code>eval()</code> also supports <code>checkpoint_interval=&lt;commit_every_N_samples&gt;</code>, which checkpoints to disk every N samples to reduce rework after unexpected interruptions. Internally, data is written before metadata; if a crash occurs mid-write, the system can resume from the previous checkpoint instead of restarting from the first sample.</p>
<blockquote>
<p>Note: in this case, versions are stored under the <code>/versions</code> directory.</p>
</blockquote>
<p>With large datasets, not every sample path is guaranteed to be valid (e.g., invalid paths, wrong file formats such as treating PNG as JPEG). You may choose to ignore such errors via <code>.eval(..., ignore_errors=True)</code>; otherwise frequent exception handling can significantly slow down ingestion.</p>
<ul>
<li>For details, see <code>[muller.compute]()</code>.</li>
<li>For details, see <code>[eval()]()</code>.</li>
</ul>
<h3 id="2-use-with-for-better-write-performance">2. Use <code>with</code> for Better Write Performance</h3>
<ol>
<li>In MULLER, each independent update is pushed to the target persistent storage immediately (through an LRU cache; see <code>_set_item()</code> and <code>flush()</code>). If you have many small updates and the data is stored remotely, write time can increase significantly. For example, the following pattern pushes an update on every <code>.append()</code>:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">my_tensor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</code></pre></div>
<ol>
<li>Using a <code>with</code> block typically improves performance. Updates are batched and flushed when the <code>with</code> block completes (or when the local cache is full), reducing fragmented writes:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">ds</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">my_tensor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c1"># or other write operations: create, update, etc.</span>
</code></pre></div>
<h3 id="3-why-a-dataset-become-corrupted-and-how-to-recover">3. Why a Dataset Become Corrupted, and How to Recover?</h3>
<p>If your program is interrupted unexpectedly (e.g., a crash during append/pop), the dataset may become inconsistent: some tensors may have been updated while others were not. In such cases, you can use <code>ds.reset()</code> to roll back illegal, uncommitted operations and return to the most recent valid commit.</p>
<ol>
<li><strong>Scenario A:</strong> The dataset (or some tensors) cannot be read (e.g., you see an error like below).</li>
</ol>
<div class="highlight"><pre><span></span><code>DatasetCorruptError: Exception occured (see Traceback). The dataset maybe corrupted. Try using `reset=True` to reset HEAD changes and load the previous commit. This will delete all uncommitted changes on the branch you are trying to load.
</code></pre></div>
<p>Recovery: reload with <code>reset=True</code>.</p>
<div class="highlight"><pre><span></span><code><span class="n">ds</span> <span class="o">=</span> <span class="n">muller</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="o">&lt;</span><span class="n">dataset_path</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<ol>
<li><strong>Scenario B:</strong> The dataset is corrupted (e.g., tensor lengths are inconsistent).</li>
</ol>
<p>Recovery: load without integrity checking, then reset.</p>
<div class="highlight"><pre><span></span><code><span class="n">ds</span> <span class="o">=</span> <span class="n">muller</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="o">&lt;</span><span class="n">dataset_path</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">check_integrity</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># skip integrity check</span>
<span class="n">ds</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
</code></pre></div>
<ul>
<li>For details on <code>check_integrity</code> during load, see <code>[muller.dataset()]()</code> and <code>[muller.load()]()</code>.</li>
<li>For details on reset, see <code>[dataset.reset()]()</code>.</li>
<li>Note: once you reset, all uncommitted changes will be deleted.</li>
<li>For large datasets, prefer <strong>checkpointing</strong> or <strong>committing frequently</strong> so recovery is easier after unexpected failures.</li>
</ul>
<h3 id="4-keys-to-efficient-operations-on-obs">4. Keys to Efficient Operations on OBS</h3>
<ol>
<li>
<p>Use a sufficiently capable OBS client and sufficient bandwidth.</p>
</li>
<li>
<p>The most efficient MULLER usage is typically “local → local” or “local → OBS bucket”. If you use the Huashan production environment with the <code>huashan://</code> prefix (or an implicit remote path), the call chain may become “local → OBS bucket A (personal) → OBS bucket B (shared)”. Frequent reads/writes via limited OBS APIs between buckets can significantly impact performance.</p>
</li>
<li>We also expect richer low-level OBS APIs (e.g., batch read/write, batch delete, offset-based partial read/write) to improve small-file transfer efficiency. References: <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html">boto3</a>, <a href="https://github.com/huaweicloud/huaweicloud-sdk-python-obs/tree/master/examples">Huawei OBS</a>.</li>
</ol>
<blockquote>
<p>Note: transferring massive numbers of small files on OBS is inherently costly. Partial read/write can help; see <a href="https://github.com/huaweicloud/huaweicloud-sdk-python-obs/blob/master/examples/concurrent_upload_part_sample.py">Huawei OBS partial read (with offset)</a>.</p>
</blockquote>
<ol>
<li>Use enough memory so the LRU cache can hold more data per flush. If needed, increase <code>DEFAULT_MEMORY_CACHE_SIZE</code> in <code>constants.py</code> (default: 20 GB).</li>
</ol>
<blockquote>
<p>Note: (1) is typically a prerequisite for (2).</p>
</blockquote>
<h3 id="5-concurrency-write-locks-in-muller">5. Concurrency: Write Locks in MULLER</h3>
<p>MULLER supports basic concurrent-write protection via <strong>file locks</strong> (including in the Huashan notebook environment). The following locks are used:</p>
<ol>
<li><code>version_control_info.lock</code>: since branch users can write to <code>version_control_info.json</code>, this lock ensures only one writer at a time; others wait until the lock is released.</li>
<li><code>dataset_lock.lock</code>: once a dataset is created in a path, this lock is created. While it exists, creating a new dataset in the same path (e.g., via <code>ds.empty()</code>) is blocked; otherwise you may see:</li>
</ol>
<div class="highlight"><pre><span></span><code>muller.util.exceptions.DatasetHandlerError: A dataset already exists at the given path (temp_dataset/). If you want to create a new empty dataset, either specify another path or use overwrite=True. If you want to load the dataset that exists at this path, use muller.load() instead.
</code></pre></div>
<ol>
<li><code>queries.lock</code>: used in two cases:</li>
<li>Created when <code>ds.save_view()</code> starts and released when it completes, to prevent concurrent use during view saving.</li>
<li>Created when <code>ds.delete_view()</code> starts and released when it completes, to prevent concurrent use during deletion. (Currently only the view creator can delete a view, so extreme cases are largely avoided.)</li>
</ol>
<p>Limitations of file locks:</p>
<ul>
<li>Lock creation/deletion performance depends on the underlying OBS (NSP) file I/O performance.</li>
<li>Lock atomicity depends on the atomicity guarantees of the underlying OBS (NSP) APIs.</li>
</ul>
<p>MULLER also supports <strong>Redis-based distributed locks</strong>. Three lock types are currently supported:</p>
<ol>
<li>Branch-head lock: locks the head-node resources of a branch.</li>
<li>Version-control lock: locks shared resources across dataset versions (version-control metadata).</li>
<li>Branch lock: locks predecessor versions of an entire branch (not required in v0.6.7 and earlier).</li>
</ol>
<p>To avoid deadlocks, if you need multiple lock types, acquire them strictly in the order 1 → 2 → 3.</p>
<p>Note: MULLER currently has no read locks, so <strong>dirty reads</strong> are allowed (e.g., user B may observe partial intermediate states while user A is writing).</p>
<h3 id="6-how-is-muller-different-from-deeplake">6. How Is MULLER Different from Deeplake?</h3>
<p>Deeplake is closed-source. MULLER adopts a subset of Deeplake-like interfaces but uses its own file layout and includes major performance optimizations and refactoring for version control, loading, and OBS support.</p>
<p>Key differences include:</p>
<ol>
<li>File layout: MULLER’s file organization is self-designed for higher I/O efficiency.</li>
<li>Vectorized search acceleration: not available in Deeplake; implemented in MULLER.</li>
<li>Version control: Git-for-data style; MULLER provides self-developed <code>merge</code> and <code>diff</code> for more advanced workflows.</li>
<li>Multi-user concurrency handling and locks: implemented in MULLER.</li>
<li>Branch permission control: implemented in MULLER.</li>
<li>High-performance DataLoader: implemented in MULLER.</li>
</ol>
<h3 id="7-other">7. Other</h3>
<ol>
<li>Fetch adjacent data in the chunk</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># Fetch adjacent data in the chunk -&gt; increases speed when loading sequentially,</span>
<span class="c1"># or when a tensor&#39;s data fits in the cache.</span>
<span class="n">numeric_label</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(</span><span class="n">fetch_chunks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div>
<blockquote>
<p>Note: If <code>True</code>, full chunks will be retrieved from the storage; otherwise only required bytes will be retrieved. This will always be <code>True</code> even if specified as <code>False</code> in the following cases: (1) the tensor is ChunkCompressed; (2) the chunk being accessed has more than 128 samples.</p>
</blockquote>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.top", "navigation.sections", "navigation.expand", "navigation.instant", "navigation.tracking", "content.code.copy", "content.action.edit", "search.highlight", "search.suggest"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>